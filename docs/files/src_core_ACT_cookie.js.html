<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>src/core/ACT_cookie.js - ACT.js</title>
    <link rel="stylesheet" href="https://s.yimg.com/zz/combo?yui-s:3.14.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="icon" href="https://s.yimg.com/rz/l/favicon.ico">
    <script src="https://s.yimg.com/zz/combo?yui-s:3.14.1/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
                <h1><img src="https://s.yimg.com/cv/ae/global/ACTJS/logo/ACT.js.logo.png" title="ACT.js" width="150"></h1>
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 1.1.0</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
                    <h2 class="off-left">APIs</h2>
                    <div id="api-tabview" class="tabview">
                        <ul class="tabs">
                            <li><a href="#api-classes">Classes</a></li>
                            <li><a href="#api-modules">Modules</a></li>
                            <li><a href="#api-demos">Demo and Examples</a></li>
                        </ul>
                
                        <div id="api-tabview-filter">
                            <input type="search" id="api-filter" placeholder="Type to filter APIs">
                        </div>
                
                        <div id="api-tabview-panel">
                            <ul id="api-classes" class="apis classes">
                                <li><a href="../classes/ACT.html">ACT</a></li>
                                <li><a href="../classes/ActionsQueue.html">ActionsQueue</a></li>
                                <li><a href="../classes/Base.html">Base</a></li>
                                <li><a href="../classes/Capability.html">Capability</a></li>
                                <li><a href="../classes/CapabilitySkeleton.html">CapabilitySkeleton</a></li>
                                <li><a href="../classes/Class.html">Class</a></li>
                                <li><a href="../classes/ContentAdobeEdge.html">ContentAdobeEdge</a></li>
                                <li><a href="../classes/ContentCarousel.html">ContentCarousel</a></li>
                                <li><a href="../classes/ContentContainer.html">ContentContainer</a></li>
                                <li><a href="../classes/ContentHtml5.html">ContentHtml5</a></li>
                                <li><a href="../classes/ContentImage.html">ContentImage</a></li>
                                <li><a href="../classes/ContentProgressBar.html">ContentProgressBar</a></li>
                                <li><a href="../classes/ContentSwf.html">ContentSwf</a></li>
                                <li><a href="../classes/ContentThirdParty.html">ContentThirdParty</a></li>
                                <li><a href="../classes/ContentVideoFlash.html">ContentVideoFlash</a></li>
                                <li><a href="../classes/ContentVideoHtml.html">ContentVideoHtml</a></li>
                                <li><a href="../classes/ContentYoutube.html">ContentYoutube</a></li>
                                <li><a href="../classes/Cookie.html">Cookie</a></li>
                                <li><a href="../classes/CustomData.html">CustomData</a></li>
                                <li><a href="../classes/Debug.html">Debug</a></li>
                                <li><a href="../classes/Dom.html">Dom</a></li>
                                <li><a href="../classes/DwellTime.html">DwellTime</a></li>
                                <li><a href="../classes/Enabler.html">Enabler</a></li>
                                <li><a href="../classes/Environment.html">Environment</a></li>
                                <li><a href="../classes/Event.html">Event</a></li>
                                <li><a href="../classes/Flash.html">Flash</a></li>
                                <li><a href="../classes/IO.html">IO</a></li>
                                <li><a href="../classes/Json.html">Json</a></li>
                                <li><a href="../classes/Lang.html">Lang</a></li>
                                <li><a href="../classes/LayersList.html">LayersList</a></li>
                                <li><a href="../classes/LayerStandard.html">LayerStandard</a></li>
                                <li><a href="../classes/Scaffolding.html">Scaffolding</a></li>
                                <li><a href="../classes/Screen.html">Screen</a></li>
                                <li><a href="../classes/SecureDarla.html">SecureDarla</a></li>
                                <li><a href="../classes/StandardAd.html">StandardAd</a></li>
                                <li><a href="../classes/Tracking.html">Tracking</a></li>
                                <li><a href="../classes/UA.html">UA</a></li>
                                <li><a href="../classes/Util.html">Util</a></li>
                                <li><a href="../classes/VideoEvents.html">VideoEvents</a></li>
                            </ul>
                
                            <ul id="api-modules" class="apis modules">
                                <li><a href="../modules/ACT.html">ACT</a></li>
                                <li><a href="../modules/actionsQueue.html">actionsQueue</a></li>
                                <li><a href="../modules/Base.html">Base</a></li>
                                <li><a href="../modules/CapabilitySkeleton.html">CapabilitySkeleton</a></li>
                                <li><a href="../modules/ContentAdobeEdge.html">ContentAdobeEdge</a></li>
                                <li><a href="../modules/ContentCarousel.html">ContentCarousel</a></li>
                                <li><a href="../modules/ContentContainer.html">ContentContainer</a></li>
                                <li><a href="../modules/ContentHtml5.html">ContentHtml5</a></li>
                                <li><a href="../modules/ContentImage.html">ContentImage</a></li>
                                <li><a href="../modules/ContentProgressBar.html">ContentProgressBar</a></li>
                                <li><a href="../modules/ContentSwf.html">ContentSwf</a></li>
                                <li><a href="../modules/ContentThirdParty.html">ContentThirdParty</a></li>
                                <li><a href="../modules/ContentVideoFlash.html">ContentVideoFlash</a></li>
                                <li><a href="../modules/ContentVideoHtml.html">ContentVideoHtml</a></li>
                                <li><a href="../modules/ContentYoutube.html">ContentYoutube</a></li>
                                <li><a href="../modules/Cookie.html">Cookie</a></li>
                                <li><a href="../modules/DwellTime.html">DwellTime</a></li>
                                <li><a href="../modules/Enabler.html">Enabler</a></li>
                                <li><a href="../modules/environment.html">environment</a></li>
                                <li><a href="../modules/IO.html">IO</a></li>
                                <li><a href="../modules/LayersList.html">LayersList</a></li>
                                <li><a href="../modules/LayerStandard.html">LayerStandard</a></li>
                                <li><a href="../modules/Scaffolding.html">Scaffolding</a></li>
                                <li><a href="../modules/Screen.html">Screen</a></li>
                                <li><a href="../modules/SecureDarla.html">SecureDarla</a></li>
                                <li><a href="../modules/StandardAd.html">StandardAd</a></li>
                                <li><a href="../modules/Tracking.html">Tracking</a></li>
                            </ul>
                
                            <ul id="api-demos" class="apis demos">
                                <li><a href="../demo/ACT_Demo_300x250.html">300x250</a></li>
                                <li><a href="../demo/ACT_Demo_300x250_tracking.html">300x250_tracking</a></li>
                                <li><a href="../demo/ACT_Demo_TrackingExample.html">TrackingExample</a></li>
                                <li><a href="../demo/ACT_Demo_animation.html">animation</a></li>
                                <li><a href="../demo/ACT_Demo_billboard.html">billboard</a></li>
                                <li><a href="../demo/ACT_Demo_billboard-enabler.html">billboard-enabler</a></li>
                                <li><a href="../demo/ACT_Demo_billboard-expandable-enabler.html">billboard-expandable-enabler</a></li>
                                <li><a href="../demo/ACT_Demo_billboard_html_video.html">billboard_html_video</a></li>
                                <li><a href="../demo/ACT_Demo_billboard_html_video_rtl.html">billboard_html_video_rtl</a></li>
                                <li><a href="../demo/ACT_Demo_carousel.html">carousel</a></li>
                                <li><a href="../demo/ACT_Demo_dwelltime.html">dwelltime</a></li>
                                <li><a href="../demo/ACT_Demo_enabler_expand.html">enabler_expand</a></li>
                                <li><a href="../demo/ACT_Demo_enabler_fullscreen_expand.html">enabler_fullscreen_expand</a></li>
                                <li><a href="../demo/ACT_Demo_enabler_target.html">enabler_target</a></li>
                                <li><a href="../demo/ACT_Demo_floating.html">floating</a></li>
                                <li><a href="../demo/ACT_Demo_force_env.html">force_env</a></li>
                                <li><a href="../demo/ACT_Demo_html5_enabler.html">html5_enabler</a></li>
                                <li><a href="../demo/ACT_Demo_html5_standard.html">html5_standard</a></li>
                                <li><a href="../demo/ACT_Demo_icons.html">icons</a></li>
                                <li><a href="../demo/ACT_Demo_input_data.html">input_data</a></li>
                                <li><a href="../demo/ACT_Demo_login_html.html">login_html</a></li>
                                <li><a href="../demo/ACT_Demo_overwrite_env.html">overwrite_env</a></li>
                                <li><a href="../demo/ACT_Demo_splash_ad.html">splash_ad</a></li>
                                <li><a href="../demo/ACT_Demo_tablet_expandable.html">tablet_expandable</a></li>
                                <li><a href="../demo/ACT_Demo_video_event.html">video_event</a></li>
                                <li><a href="../demo/ACT_Demo_video_html.html">video_html</a></li>
                            </ul>
                
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
                    Show:
                    <label for="api-show-inherited">
                        <input type="checkbox" id="api-show-inherited" checked>
                        Inherited
                    </label>
            
                    <label for="api-show-protected">
                        <input type="checkbox" id="api-show-protected">
                        Protected
                    </label>
            
                    <label for="api-show-private">
                        <input type="checkbox" id="api-show-private">
                        Private
                    </label>
                    <label for="api-show-deprecated">
                        <input type="checkbox" id="api-show-deprecated">
                        Deprecated
                    </label>
            
                </div>
            
            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
<h1 class="file-heading">File: src/core/ACT_cookie.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
/*
 * Copyright 2016, Yahoo Inc.
 * Copyrights licensed under the New BSD License.
 * See the accompanying LICENSE file for terms.
 */

/* global ACT */
/* eslint new-cap: 0 */
ACT.define(&#x27;Cookie&#x27;, [/*@&lt;*/&#x27;Debug&#x27;, /*&gt;@*/ &#x27;Json&#x27;, &#x27;Lang&#x27;, &#x27;Event&#x27;], function (ACT) {
    &#x27;use strict&#x27;;

    /* ACT.js Shorthand */
    var JSON = ACT.Json;
    var Lang = ACT.Lang;
    var Event = ACT.Event;

    /**
     * default values
     */
    var DEFAULT_DOMAIN = &#x27;yahoo.com&#x27;;
    var DEFAULT_PATH = &#x27;/&#x27;;
    var DEFAULT_EXPIRES = 172800000;
    var DEFAULT_COOKIE_NAME = &#x27;CRZY&#x27;;
    var DEFAULT_NAME = &#x27;ACTCookie&#x27;;
    var ENCODE = encodeURIComponent;
    var DECODE = decodeURIComponent;
    var DEFAULT_FREQ_CAP = 1;

    /* Private Variables */
    var yAPI = null;
    var safeFrameKey = null;
    var eventReadCookie = null;
    var eventReadCookieFailed = null;

    // constant value for eaiser references
    var COOKIE_TYPES = {
        STANDARD: &#x27;standard&#x27;,
        SAFEFRAME: &#x27;safeFrame&#x27;
    };

    /* SecureDarla prefix -  to listen to SafeFrame Notifications - shorthand */
    var EVENT_DARLA_PREFIX = &#x27;secureDarla:&#x27;; // this prefix to use for message coming from sDarla API

    /**
     * EVENTS
     */
    var EVENT_SDARLA_REGISTER = EVENT_DARLA_PREFIX + &#x27;register&#x27;;
    var EVENT_SDARLA_FAIL = EVENT_DARLA_PREFIX + &#x27;failed&#x27;;
    var EVENT_SDARLA_REGISTER_UPDATE = EVENT_DARLA_PREFIX + &#x27;register-update&#x27;;
    var EVENT_SDARLA_READ_COOKIE = EVENT_DARLA_PREFIX + &#x27;read-cookie&#x27;;
    var EVENT_SDARLA_WRITE_COOKIE = EVENT_DARLA_PREFIX + &#x27;write-cookie&#x27;;

    var EVENT_SAFEFRAME_NO_SUPPORT = &#x27;sframe:nosupport&#x27;;

    var EVENT_REGISTER_AD = &#x27;localRegister:registerAd&#x27;;
    var EVENT_REGISTER_AD_COMPLETE = &#x27;localRegister:registerAd:complete&#x27;;
    var EVENT_TRACK_STATE = &#x27;localRegister:trackState&#x27;;
    var EVENT_TRACK_STATE_COMPLETE = &#x27;localRegister:trackState:complete&#x27;;
    var EVENT_UPDATE_AD_EVENT = &#x27;localRegister:updateAdEvent&#x27;;
    var EVENT_UPDATE_AD_EVENT_COMPLETE = &#x27;localRegister:updateAdEvent:complete&#x27;;
    var EVENT_REGISTER_ACTIONS = &#x27;register:Actions&#x27;;
    var EVENT_COMPLETE_ACTIONS = &#x27;complete:action&#x27;;

    /* event which will get the value of given state */
    var EVENT_GET_STATE = &#x27;localRegister:getState&#x27;;
    var EVENT_GET_STATE_COMPLETE = &#x27;localRegister:getState:complete&#x27;;

    /* Cookie Specific Events */
    var EVENT_COOKIE_GETDATA_COMPLETE = &#x27;Cookie:getData:complete&#x27;;
    // var EVENT_COOKIE_SAVEDATA_COMPLETE = &#x27;Cookie:saveData:complete&#x27;;
    var EVENT_COOKIE_READY = &#x27;Cookie:internal:ready&#x27;;
    var EVENT_COOKIE_SAVED = &#x27;Cookie:internal:saved&#x27;;

    /* Cookie Status Codes */
    var COOKIE_STATUS_OK = 0; // Cookie is OK and ready - data returned.
    var COOKIE_STATUS_NO_COOKIE = -1; // No Cookies available - SafeFrame and Standard
    var COOKIE_STATUS_PENDING = 10;
    // var ERROR_SAFEFRAME_NO_COOKIE = &#x27;NO_SF_COOKIE&#x27;;
    var cookieActions;
    var standardCookie;
    var safeframeCookie;
    /*@&lt;*/
    var debug = ACT.Debug;
    debug.log(&#x27;[ ACT_cookie.js ]: loaded&#x27;);
    /*&gt;@*/


    /**
     * Actions to be registered
     */
    /* unit test: ignore as events stubbed */
    /* istanbul ignore next */
    cookieActions = [{
        type: &#x27;trackState&#x27;,
        argument: {
            stateId: {
                name: &#x27;stateId&#x27;,
                test: function (value) {
                    return (Lang.isString(value));
                }
            },
            state: {
                name: &#x27;state&#x27;,
                test: function (value) {
                    return (Lang.isString(value));
                }
            },
            timeout: {
                name: &#x27;timeout&#x27;,
                test: function (value) {
                    return Lang.isNumber(value) || value === undefined || value === null;
                }
            }
        },
        process: function (actionId, args) {
            var updateAdEventListener = Event.on(EVENT_TRACK_STATE_COMPLETE, function () {
                updateAdEventListener.remove();
                // finish queue action
                Event.fire(EVENT_COMPLETE_ACTIONS, actionId);
            });

            // fire action for update ad event
            Event.fire(EVENT_TRACK_STATE, {
                stateId: args.stateId,
                stateValue: args.state
            });
        }

    }, {
        type: &#x27;updateAdEvent&#x27;,
        argument: {
            eventName: {
                name: &#x27;eventName&#x27;,
                test: function (value) {
                    return (Lang.isString(value));
                }
            },
            timeout: {
                name: &#x27;timeout&#x27;,
                test: function (value) {
                    return Lang.isNumber(value) || value === undefined || value === null;
                }
            }
        },
        process: function (actionId, args) {
            var updateAdEventListener = Event.on(EVENT_UPDATE_AD_EVENT_COMPLETE, function () {
                updateAdEventListener.remove();
                Event.fire(EVENT_COMPLETE_ACTIONS, actionId);
            });

            Event.fire(EVENT_UPDATE_AD_EVENT, {
                eventName: args.eventName
            });
        }
    }];

    /**
     * Cookie Helper Utilities - STANDARD COOKIE
     * @private
     */
    standardCookie = {

        /**
         * The type of the current cookie functionality in use.
         * @attribute standardCookie.TYPE
         * @type {String}
         * @initOnly
         * @private
         */
        TYPE: COOKIE_TYPES.STANDARD,

        /**
         * Test to see if user has cookies enabled.
         * @param {String} domain The domain name of the cookie.
         * @method standardCookie.test
         * @return {Boolean} true is able to write cookies false otherwise.
         * @private
         */
        test: function () {
            /* istanbul ignore next */
            var cookieEnabled = !!(navigator.cookieEnabled);
            /* unit test: cannot test navigator obj */
            /* istanbul ignore next */
            if (typeof navigator.cookieEnabled === &#x27;undefined&#x27; &amp;&amp; !cookieEnabled) {
                document.cookie = &#x27;fpadtestcookie&#x27;;
                cookieEnabled = (document.cookie.indexOf(&#x27;fpadtestcookie&#x27;) !== -1);
            }
            return cookieEnabled;
        },

        /**
         * Sets the cookie
         * @param {String} cookieName The name of the cookie.
         * @param {Object} cookieContent The value of the cookie - string OR simple Object. Currently only supports the following character set: [a-zA-Z0-9&amp;=_]
         * @param {String} domain Domain under which to store the cookie. Defaults to yahoo.com
         * @param {Number} expires How long to stay alive. Defaults to 24 hours
         * @param {String} path Path under which to store the cookie. Defaults to /
         * @method standardCookie.set
         * @private
         */
        set: function (cookieName, cookieContent, domain, expires, path) {
            var date = new Date();
            var cookieContentHash = ENCODE(JSON.stringify(cookieContent));

            domain = domain || DEFAULT_DOMAIN;
            path = path || DEFAULT_PATH;
            expires = expires || DEFAULT_EXPIRES;

            date.setTime(date.getTime() + expires);
            document.cookie = cookieName + &#x27;=&#x27; + cookieContentHash + &#x27;; expires=&#x27; + date.toGMTString() + &#x27;; domain=&#x27; + domain + &#x27;; path=&#x27; + path;

            /**
             * Fire event in standard ad as well so we the same appoarch with Darla
             */
            Event.fire(EVENT_COOKIE_SAVED, {});
        },

        /**
         * Get the cookie
         * @param {String} cookieName The name of the cookie to get.
         * @return {Object} The cookie data in an object.
         * @method standardCookie.get
         * @private
         */
        get: function (c) {
            var localCookie = &#x27; &#x27; + document.cookie + &#x27;;&#x27;;
            var cookieRegEx = new RegExp(&#x27; &#x27; + c + &#x27;=(.*?);&#x27;);
            var cookieValue = localCookie.match(cookieRegEx);
            var cookieValueReturned = 0;
            if (cookieValue) {
                cookieValue = DECODE(cookieValue[1]);
            }
            if (cookieValue) {
                cookieValueReturned = JSON.parse(cookieValue);
            }

            return cookieValueReturned;
        },

        /**
         * Remove the cookie - set it to expire.
         * @param {String} cookieName The name of the cookie
         * @param {String} domain The domain name of the cookie.
         * @method standardCookie.remove
         * @private
         */
        remove: function (cookieName, domain, path) {
            var currentDomain = domain || DEFAULT_DOMAIN;
            var currentPath = path || DEFAULT_PATH;
            standardCookie.set(cookieName, &#x27;&#x27;, currentDomain, -345600000, currentPath);
            return true;
        }
    };

    /**
     * Cookie Helper Utilities - SafeFrame COOKIE
     * @private
     */
    safeframeCookie = {

        /**
         * The type of the current cookie functionality in use.
         * @attribute safeframeCookie.TYPE
         * @type {String}
         * @initOnly
         * @private
         */
        TYPE: COOKIE_TYPES.SAFEFRAME,

        /**
         * SafeFrame Cookie data
         * @type {Object}
         * @private
         */
        data: null,

        /**
         * A simple SafeFrame status variable. If true then we&#x27;re waiting on SafeFrame cookie reply. If &#x27;false&#x27; then we have SafeFrame cookie data
         * NULL otherwise
         * @type {Boolean}
         * @private
         */
        pending: null,

        /**
         * Test to see if user has cookies enabled.
         * @method safeframeCookie.test
         * @return {Boolean} true is able to write cookies false otherwise.
         * @private
         */
        test: function () {
            /* istanbul ignore else */
            if (yAPI &amp;&amp; Lang.isFunction(yAPI.supports)) {
                return yAPI.supports(&#x27;read-cookie&#x27;) &amp;&amp; yAPI.supports(&#x27;write-cookie&#x27;);
            }
            return false;
        },

        /**
         * Sets the SafeFrame cookie - For consistency, the parameters it takes are the same as the StandardCookie
         * However, the function only uses cookieName and cookieContent. &#x27;domain&#x27;, &#x27;expires&#x27; and &#x27;path&quot; are simply ignored.
         * @param {String} cookieName The name of the cookie.
         * @param {Object} cookieContent The value of the cookie - string OR simple Object. Currently only supports the following character set: [a-zA-Z0-9&amp;=_]
         * @param {String} domain Domain under which to store the cookie. Defaults to yahoo.com
         * @param {Number} expires How long to stay alive. Defaults to 24 hours
         * @param {String} path Path under which to store the cookie. Defaults to /
         * @method safeframeCookie.set
         * @private
         */
        set: function (cookieName, cookieContent) {
            var eventListener;
            /* unit test: will always return true */
            /* istanbul ignore else */
            if (safeframeCookie.test()) {
                // listen for return from Darla
                /* istanbul ignore next */
                eventListener = Event.on(EVENT_SDARLA_WRITE_COOKIE, function (data) {
                    eventListener.remove();
                    Event.fire(EVENT_COOKIE_SAVED, data);
                });

                /*@&lt;*/
                debug.info(&#x27;[ ACT_cookie.js ]: save darla cookie&#x27;, cookieName, cookieContent);
                /*&gt;@*/

                safeframeCookie.data = cookieContent;
                yAPI.cookie(cookieName, {
                    key: safeFrameKey,
                    value: JSON.stringify(cookieContent)
                });
            }
        },

        /**
         * Get the cookie
         * @param {String} cookieName The name of the cookie to get.
         * @return {Object} The cookie data in an object.
         * @method safeframeCookie.get
         * @private
         */
        get: function (cookieName) {
            /* unit test: will always return true */
            /* istanbul ignore else */
            if (safeframeCookie.test() === true) {
                // if reading Darla cookie is finish then return stored data
                // unit test: cannot test wait
                /* istanbul ignore if */
                if (safeframeCookie.pending === false) {
                    Event.fire(EVENT_COOKIE_READY, { status: COOKIE_STATUS_OK, data: safeframeCookie.data });
                } else if (safeframeCookie.pending === true) {
                    /* if still waiting for Darla then keeps waiting */
                    return COOKIE_STATUS_PENDING;
                } else {
                    /* if Darla cookie is not read yet then  read it and put in pending state */
                    safeframeCookie.getSFCookie(cookieName);
                    return COOKIE_STATUS_PENDING;
                }
            } else {
                safeframeCookie.data = null;
                Event.fire(EVENT_COOKIE_READY, { status: COOKIE_STATUS_NO_COOKIE, data: safeframeCookie.data });
            }
            /* Since we are no longer pending. We can return the cookie data right away. */
            return safeframeCookie.data;
        },

        /**
         * Initializing SafeFrame helper functions.
         * @method safeframeCookie.getSFCookie
         * @param {String} cookieName The name of the cookie to pick up from SafeFrame.
         * @private
         */
        getSFCookie: function (cookieName) {
            /* unit test: will always return true */
            /* istanbul ignore else */
            if (safeframeCookie.test()) {
                /*@&lt;*/
                debug.info(&#x27;[ ACT_cookie.js ]: Darla supports cookies, let read it&#x27;);
                /*&gt;@*/
                /* Call Darla read cookie function - in a set timeout to push it to the bottom of the execution stack */

                setTimeout(function () {
                    yAPI.cookie(cookieName, {
                        key: safeFrameKey
                    });
                }, 10);
                safeframeCookie.pending = true;
            } else {
                /*@&lt;*/
                debug.info(&#x27;[ ACT_cookie.js ]: Darla does not support cookies, return error status&#x27;);
                /*&gt;@*/
                safeframeCookie.pending = false;
                safeframeCookie.data = null;
                /* unit test: events have been stubbed */
                /* istanbul ignore next */
                Event.fire(EVENT_COOKIE_READY, { status: COOKIE_STATUS_NO_COOKIE, data: safeframeCookie.data });
            }
        },

        /**
         * Read the SafeFrame Cookie data into a local variable.
         * @method safeframeCookie.readSFCookie
         * @param {Object} data passed in from the SafeFrame API
         * @private
         */
        readSFCookie: function (data) {
            /* Only execute the code if we have a read-cookie command - so to ignore other &#x27;failed&#x27; commands */
            if (&#x27;cmd&#x27; in data &amp;&amp; data.cmd === &#x27;read-cookie&#x27;) {
                if (&#x27;info&#x27; in data &amp;&amp; Lang.isObjectEmpty(data.info)) {
                    /* We have an empty info object, which implies we had an error occur. - fire off &#x27;no cookie&#x27; */
                    Event.fire(EVENT_COOKIE_READY, { status: COOKIE_STATUS_NO_COOKIE, data: safeframeCookie.data });
                } else {
                    // Msg from DARLA: failed {&#x27;cmd&#x27;:&#x27;read-cookie&#x27;,&#x27;info&#x27;:{},&#x27;value&#x27;:null,&#x27;reason&#x27;:&#x27;no valid cookie name&#x27;,&#x27;key&#x27;:{}}
                    if (&#x27;value&#x27; in data) {
                        safeframeCookie.data = JSON.parse(DECODE(data.value)) || {};
                    } else {
                        /* Even if we don&#x27;t have a cookie set, we obviously are able to get it. Which means we can set it also.
                         * Initializing it to an empty object here is OK
                         */
                        safeframeCookie.data = {};
                    }
                    safeframeCookie.pending = false;

                    /* Fire off an &#x27;internal&#x27; ready event. To notify whomever is interested that the data is ready for processing. */
                    Event.fire(EVENT_COOKIE_READY, { status: COOKIE_STATUS_OK, data: safeframeCookie.data });
                }
            }
        },

        /**
         * Remove the cookie - set it to expire.
         * @param {String} cookieName The name of the cookie
         * @param {String} domain The domain name of the cookie.
         * @method safeframeCookie.remove
         * @private
         */
        remove: function (cookieName) {
            // To remove the cookie, we set it&#x27;s contents to an empty string
            safeframeCookie.set(cookieName, &#x27;&#x27;);
            return true;
        }
    };

    /**
     * ACT Cookie functionality. Enables ads to set and get cookies.
     *
     *     var conf = {
     *         expires: 172800000,
     *         default_cookieName: &#x27;CRZY&#x27;,
     *         path: &#x27;/&#x27;,
     *         domain: &#x27;yahoo.com&#x27;,
     *         name: &#x27;cookieName&#x27;
     *         freq_cap : 1
     *     };
     *     var cookie = new cookie( conf, this);
     *
     * @class Cookie
     * @module Cookie
     * @requires json, lang, event, debug
     *
     */
    function cookie(conf, ref) {
        var cookieConf = conf || {};
        /*@&lt;*/
        debug.log(&#x27;[ ACT_cookie.js ]: Constructor - setting defaults.&#x27;, conf);
        /*&gt;@*/
        this.DEFAULT_EXPIRES = cookieConf.expires || DEFAULT_EXPIRES;
        this.DEFAULT_COOKIE_NAME = cookieConf.default_cookieName || DEFAULT_COOKIE_NAME;
        this.DEFAULT_PATH = cookieConf.path || DEFAULT_PATH;
        this.DEFAULT_DOMAIN = cookieConf.domain || DEFAULT_DOMAIN;
        this.COOKIE_NAME = cookieConf.name || DEFAULT_NAME;
        this.FREQ_CAP = cookieConf.freq_cap || DEFAULT_FREQ_CAP;

        if (ref) {
            this.ref = ref;
        }

        // initialize some events
        this.initializeEventListeners();

        /* istanbul ignore next */
        // register actions to action queues;
        Event.fire(EVENT_REGISTER_ACTIONS, cookieActions);

        return this;
    }

    /**
     * @attribute ATTRS
     * @type {{NAME: string, version: string}}
     * @initOnly
     */
    cookie.ATTRS = {
        NAME: &#x27;Cookie&#x27;,
        version: &#x27;1.1.0&#x27;
    };

    /**
     * Cookie Utilities
     */
    cookie.prototype = {
        /*@&lt;*/
        /* expose stadard cookie and sf cookie for helping with testing only. They will be removed on production */
        exposedStandardCookie: standardCookie,
        exposedSafeframeCookie: safeframeCookie,
        /*&gt;@*/

        /**
         * @method initializeEventListeners
         */
        initializeEventListeners: function () {
            var root = this;
            // all event listeners will be saved in an eventList so we can clear them when cookie instance is destroyed
            root.eventList = [
                /* listener to register Darla */
                Event.on(EVENT_SDARLA_REGISTER, this.register, null, this),
                Event.on(EVENT_SDARLA_REGISTER_UPDATE, this.register, null, this),

                /* listener to register Darla */
                Event.on(EVENT_SAFEFRAME_NO_SUPPORT, this.get, null, this),

                /* listener to register Ad */
                Event.on(EVENT_REGISTER_AD, function (data) {
                    root.registerAd(data.adId);
                }),

                /* listener for update trake state into cookie */
                /* istanbul ignore next */
                Event.on(EVENT_TRACK_STATE, function (data) {
                    root.saveState(data.stateId, data.stateValue);

                    // save data to cookie
                    Event.fire(EVENT_TRACK_STATE_COMPLETE);
                }),

                /* listener for update ad event into cookie */
                Event.on(EVENT_UPDATE_AD_EVENT, function (data) {
                    root.updateAdEvent(data.eventName);
                }),

                /* listener for request get state value*/
                Event.on(EVENT_GET_STATE, function (data) {
                    root.getState(data.stateId);
                })
            ];
        },

        /**
         * @method destroy
         */
        destroy: function () {
            var eventListener;
            /* Detach all created event listeners */
            while (this.eventList.length &gt; 0) {
                eventListener = this.eventList.shift();
                if (Lang.isObject(eventListener) &amp;&amp; Lang.isFunction(eventListener.remove)) {
                    eventListener.remove();
                }
            }

            if (!Lang.isObjectEmpty(eventReadCookie) &amp;&amp; Lang.isFunction(eventReadCookie.remove)) {
                eventReadCookie.remove();
                eventReadCookie = null;
            }

            if (!Lang.isObjectEmpty(eventReadCookieFailed) &amp;&amp; Lang.isFunction(eventReadCookieFailed.remove)) {
                eventReadCookieFailed.remove();
                eventReadCookieFailed = null;
            }
        },

        /**
         * Check if is possible to set|read cookie
         * @method test
         * @return {*|Boolean}
         */
        test: function () {
            return this.cookie.test();
        },

        /**
         * Function to register an Ad to the Cookie. &lt;br/&gt;
         * The method will get cookie value, then update ad information in the cookie value before saving it back to the Cookie. &lt;/br&gt;
         * When the whole process is done, event &#x27;localRegister:registerAdComplete&#x27; will be fired with firstPlay (true | false) is passed as event parameter. &lt;br /&gt;
         *
         * @method registerAd
         * @param {String} adId ID of the ad which need to be registered to the cookie
         */
        registerAd: function () {
            var root = this;

            // wait for reading cookie data complete
            /* istanbul ignore next */
            var eventListener = Event.on(EVENT_COOKIE_GETDATA_COMPLETE, function (e) {
                var returnResult = {
                    status: COOKIE_STATUS_OK // default to ok we can use cookie
                };
                var cookieData = 0;
                var freqCap = root.FREQ_CAP;
                eventListener.remove();
                /*@&lt;*/
                debug.info(&#x27;[ ACT_cookie.js ]: EVENT_COOKIE_GETDATA_COMPLETE&#x27;, e);
                /*&gt;@*/

                /*
                 * Status returned is anything other than OK. Then we have a cookie problem.
                 * In this case, we should simply assume that cookies are not supported at all
                 * and play the ad in backup / fallback mode
                 */
                if (Lang.isObject(e) &amp;&amp; (e.status === COOKIE_STATUS_OK)) {
                    // cookie data coming from event
                    cookieData = e.data || { play: -1 };

                    /*@&lt;*/
                    debug.log(&#x27;[ ACT_cookie.js ]: Ad cookie before run&#x27;, cookieData);
                    /*&gt;@*/

                    cookieData.play = parseInt(cookieData.play, 10) + 1;
                    returnResult.firstPlay = cookieData.play &lt; freqCap;

                    cookieData.states = cookieData.states || {};
                    returnResult.states = cookieData.states;

                    /*@&lt;*/
                    debug.info(&#x27;[ ACT_cookie.js ]: register ad - saving new cookie value&#x27;, cookieData);
                    /*&gt;@*/
                    // save cookieData and wait for this process to be finished by passing callback function
                    root.set(cookieData, function () {
                        /*@&lt;*/
                        debug.info(&#x27;[ ACT_cookie.js ]: new cookie value is saved - fire event to finish registerAD&#x27;, returnResult);
                        /*&gt;@*/
                        Event.fire(EVENT_REGISTER_AD_COMPLETE, returnResult);
                    });
                } else {
                    // any other case (e.g e is not object or e.status is not ok)
                    // don&#x27;t need to get cookie, just need to send status back
                    returnResult.status = e.status;
                    Event.fire(EVENT_REGISTER_AD_COMPLETE, returnResult);
                }
            });

            /*@&lt;*/
            debug.info(&#x27;[ ACT_cookie.js ]: start register ad by reading cookie;&#x27;);
            /*&gt;@*/
            /*
             * Since this.get - is an ASYNC call which deals appropriately with cookies in both modes
             * It&#x27;s OK to simply call this.get() here.
             */
            this.get();
        },

        /**
         * Funtion to save a special state of the ad into cookie.
         *
         * @method saveState
         * @param {String} stateId
         * @param {String} stateValue
         */
        saveState: function (stateId, stateValue) {
            var root = this;
            /* istanbul ignore next */
            var eventSaveState = Event.on(EVENT_COOKIE_GETDATA_COMPLETE, function (e) {
                var cookieData = e.data;
                eventSaveState.remove();

                if (cookieData === 0) {
                    cookieData = {};
                }

                if (!Lang.isObject(cookieData.states)) {
                    cookieData.states = {};
                }

                cookieData.states[stateId] = stateValue;
                root.set(cookieData);
            });

            this.get();
        },

        /**
         * Read cookie data and return state value for the ad stored in this data
         * @method getState
         * @param {String} stateId
         */
        getState: function (stateId) {
            var eventSaveState = Event.on(EVENT_COOKIE_GETDATA_COMPLETE, function (e) {
                var result = {
                    status: e.status,
                    value: &#x27;&#x27;
                };
                var cookieData = e.data;
                eventSaveState.remove();

                if (Lang.isObject(cookieData) &amp;&amp; Lang.isObject(cookieData.states)) {
                    result.value = cookieData.states[stateId];
                }

                Event.fire(EVENT_GET_STATE_COMPLETE, result);
            });
            this.get();
        },

        /**
         * Saving event for ad in cookie.
         * Searching for eventname in ad information in current cookie data.
         * If the eventname is not exist inside ad information then add it with value 0.
         * If the eventname is exist inside ad information then adding 1 to its value.
         * Finally saving the cookie
         *
         * @method updateAdEvent
         * @param {String} eventName name of the event to be save
         */
        updateAdEvent: function (eventName) {
            var root = this;

            /* istanbul ignore next */
            var eventSaveAdEvent = Event.on(EVENT_COOKIE_GETDATA_COMPLETE, function (e) {
                var unique = true;
                var cookieData = e.data;
                eventSaveAdEvent.remove();

                if (cookieData === 0) {
                    cookieData = {};
                }

                if (!Lang.isObject(cookieData.events)) {
                    cookieData.events = {};
                }

                if (cookieData.events[eventName] === undefined) {
                    cookieData.events[eventName] = 0;
                    unique = true;
                } else {
                    cookieData.events[eventName] += 1;
                    unique = false;
                }

                root.set(cookieData);

                Event.fire(EVENT_UPDATE_AD_EVENT_COMPLETE, {
                    unique: unique
                });
            });

            this.get();
        },

        /**
         * Register cookie with SafeFrame - once the framework determines that the ad is running in a SafeFrame
         * This function will be called when &#x27;register&#x27; or &#x27;register-update&#x27; events are fired from the SafeFrame API
         * Upon firing those events, this function will be called to attempt a cookie get.
         * This also resets the &#x27;cookie&#x27; API to use from StandardCookie to SafeFrameCookie
         * @method register
         * @private
         * @param {Object} data sent from the SafeFrame API via the notify function.
         *
         */
        register: function (data) {
            /* Only execute this code if &#x27;key&#x27; is sent in from SafeFrame API */
            /* unit test: elses ignored due to test/framework restrictions */
            /* istanbul ignore else */
            if (&#x27;key&#x27; in data) {
                /*@&lt;*/
                debug.log(&#x27;[ ACT_cookie.js ]: Darla is available, let use it&#x27;);
                /*&gt;@*/

                // update reference of key and yAPI

                /* Keep a local reference to the SD Key */
                safeFrameKey = data.key;

                /* Keep a local reference to the yAPI */
                yAPI = data.yAPI || null;

                this.cookie = safeframeCookie;

                /* We should only read Darla cookie once, so if we are on pending or finish then don&#x27;t read Darla cookie*/
                /* istanbul ignore else */
                if (safeframeCookie.pending === null) {
                    /* listen to data returned form darla */
                    /* istanbul ignore else */
                    if (Lang.isObjectEmpty(eventReadCookie)) {
                        eventReadCookie = Event.on(EVENT_SDARLA_READ_COOKIE, this.cookie.readSFCookie, null, this);
                        eventReadCookieFailed = Event.on(EVENT_SDARLA_FAIL, this.cookie.readSFCookie, null, this);
                    }

                    /**
                     * The getSFCookie function will fire an &#x27;internal&#x27; event which no one needs to listen to
                     * So calling it right away is fair game - also speeds things up a big.
                     * &#x27;get&#x27; should be called with the DEFAULT_COOKIE_NAME
                     */
                    this.cookie.getSFCookie(this.DEFAULT_COOKIE_NAME);
                }
            }
        },

        /**
         * Simple helper function to read the cookie data
         * @method read
         * @return {Object} Set of data that was stored in the cookie.
         * @public
         */
        read: function () {
            var readCookie = this.cookie.get(this.DEFAULT_COOKIE_NAME);

            if (!readCookie) {
                return {};
            }
            return readCookie;
        },

        /**
         * Clean the cookie data by removing stale entries
         * @method clean
         * @public
         */
        clean: function () {
            // var cookie = this.cookie;
            var fullCookie = this.read();
            var date = new Date().getTime();
            var itor = null;
            var count = 0;
            // var path = this.DEFAULT_PATH;
            // var domain = this.DEFAULT_DOMAIN;
            // var default_cookieName = this.DEFAULT_COOKIE_NAME;

            if (typeof fullCookie === &#x27;object&#x27;) {
                for (itor in fullCookie) {
                    if (fullCookie[itor].expires &lt;= date) {
                        delete fullCookie[itor];
                    } else {
                        count++;
                    }
                }
                /*@&lt;*/
                debug.log(&#x27;[ ACT_cookie.js ]: set cookie called inside clean function&#x27;, count);
                /*&gt;@*/
                if (count &gt; 0) {
                    // cookie.set(default_cookieName, fullCookie, domain, path);
                } else {
                    // cookie.remove(default_cookieName, domain, path);
                }
            }
            return fullCookie;
        },

        /**
         * Remove the current cookie from the set. Deleting it completely.
         * @method remove
         * @public
         * @return {Boolean}
         */
        remove: function () {
            var fullCookie = this.read();
            var path = this.DEFAULT_PATH;
            var domain = this.DEFAULT_DOMAIN;
            var expires = this.DEFAULT_EXPIRES;
            var cookieName = this.COOKIE_NAME;
            var defaultCookieName = this.DEFAULT_COOKIE_NAME;

            if (typeof fullCookie === &#x27;object&#x27; &amp;&amp; cookieName in fullCookie) {
                fullCookie[cookieName] = null;
                delete fullCookie[cookieName];
            }

            /*@&lt;*/
            debug.log(&#x27;[ ACT_cookie.js ]: set cookie called inside remove function&#x27;);
            /*&gt;@*/
            this.cookie.set(defaultCookieName, fullCookie, domain, expires, path);
            return true;
        },

        /**
         * Set the cookie - get a cookie name (key) and the data (value)
         * @param {Object} cookieData data
         * @param {Function} callback A function to be called after cookie is saved
         * @method set
         * @public
         */
        set: function (cookieData, callback) {
            var domain = this.DEFAULT_DOMAIN;
            var expires = this.DEFAULT_EXPIRES;
            var path = this.DEFAULT_PATH;
            var defaultCookieName = this.DEFAULT_COOKIE_NAME;
            var cookieName = this.COOKIE_NAME;
            var fullCookie = this.clean(domain, path);
            var expire = new Date();
            var eventListener;

            expire = expire.getTime() + DEFAULT_EXPIRES;

            if (fullCookie.hasOwnProperty(cookieName)) {
                fullCookie[cookieName].data = cookieData;
            } else {
                fullCookie[cookieName] = {
                    expires: expire,
                    data: cookieData
                };
            }
            /* istanbul ignore next */
            eventListener = Event.on(EVENT_COOKIE_SAVED, function (data) {
                eventListener.remove();

                if (Lang.isFunction(callback)) {
                    callback(data);
                }
            });

            this.cookie.set(defaultCookieName, fullCookie, domain, expires, path);
            return true;
        },

        /**
         * Get Cookie Helper function - given a full cookie, pick out the cookie name required for the ad and fire off
         * a EVENT_COOKIE_GETDATA_COMPLETE event.
         * @method getHelper
         * @param {Object} fullCookie Containing all the cookie data received. - { &#x27;status&#x27;: COOKIE_STATUS_OK, &#x27;data&#x27;: safeframeCookie.data });
         * @private
         */
        getHelper: function (fullCookie) {
            var cookieName = this.COOKIE_NAME;
            var cookieData = 0;
            var status = fullCookie.status || COOKIE_STATUS_OK;
            var cookieDataPayload;

            if (Lang.isObject(fullCookie) &amp;&amp; fullCookie.status === COOKIE_STATUS_OK) {
                fullCookie = fullCookie.data;
                if (Lang.isObject(fullCookie) &amp;&amp; fullCookie.hasOwnProperty(cookieName)) {
                    /* then we&#x27;re updating the cookie */
                    cookieData = fullCookie[cookieName].data;
                }
            }

            /* Remove the cookie ready event - since we&#x27;ve already fired it once to get here */
            if (this.cookie_ready_event) {
                this.cookie_ready_event.remove();
            }
            /* A little easier to augment this, and log it if need be. */
            cookieDataPayload = { status: status, data: cookieData };

            /*@&lt;*/
            debug.log(&#x27;[ ACT_cookie.js ]: cookieDataPayload sent off in getdata:complete:&#x27;, cookieDataPayload);
            /*&gt;@*/
            Event.fire(EVENT_COOKIE_GETDATA_COMPLETE, cookieDataPayload);
        },

        /**
         * Get the cookie
         * @return {Object} The cookie data in an object OR 0 if no cookie has been stored
         * @method get
         * @public
         */
        get: function () {
            var fullCookie = this.read();

            if (fullCookie === COOKIE_STATUS_PENDING) {
                /* Pending a cookie response - SafeFrame is still grabbing the cookies for us. */
                this.cookie_ready_event = Event.on(EVENT_COOKIE_READY, this.getHelper, null, this);
            } else {
                /*
                 * Since Status is no longer pending, we don&#x27;t need to listen for an event and rather just go
                 * full out and call the helper directly
                 *
                 * getHelper expect {status: [cookie_status], data: [cookieData]}
                 */
                this.getHelper({
                    status: this.test() ? COOKIE_STATUS_OK : COOKIE_STATUS_NO_COOKIE,
                    data: fullCookie
                });
            }
        },

        /**
         * Expose cookie helper methods
         * @private
         */
        cookie: standardCookie
    };

    return cookie;
});

    </pre>
</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
